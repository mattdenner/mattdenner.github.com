
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Disagreement #2 - Words, code, skates</title>
  <meta name="author" content="Matthew Denner">

  
  <meta name="description" content="Following on from my previous disagreement, here&#8217;s the second one I&#8217;ve been having: You should code to the language and the environment &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mattdenner.github.com//blog/2011/11/23/disagreement-number-2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Words, code, skates" type="application/atom+xml">
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Words, code, skates</a></h1>
  
    <h2>A blog of an inline skating software engineer</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mattdenner.github.com/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Disagreement #2</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-23T20:56:00+00:00" pubdate data-updated="true">Nov 23<span>rd</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Following on from <a href="/blog/2011/11/22/disagreement--1/">my previous disagreement</a>, here&#8217;s the second one I&#8217;ve been having:</p>

<p>You should code to the language and the environment you are in.  That
means taking advantage of the features of the languages and the
frameworks that you use.</p>

<!-- more -->


<p>This all comes about because, at work, we are rewriting our main
product as it has become overburdened with issues that come about
because of the history of the codebase.  It&#8217;s been hacked about, forced
to do things it shouldn&#8217;t, and had some bad engineering decisions pushed
into it.</p>

<p>The biggest issue we have moving forward is that both the existing
system and the new one will have to run in parallel, and on the same
database, for a period.  The data we have isn&#8217;t in the best of states
and the schema itself needs some serious work to make it better, which
is not something that is possible in the timeframe we have to rewrite.</p>

<p>To allow us to place build better models on the existing schema we&#8217;re
going to have to do some serious work and I believe that we should take
advantage of some of the abilities of Ruby.  Where the existing system
has a large class hierarchy some areas we can flatten this and use the
singleton class to add behaviour to objects at runtime.</p>

<p>Let me try to put this in terms of an example:</p>

<p>Pretend that you&#8217;re making a cup of tea.  You have to transfer the water
in the kettle to a tea cup, then you have to pour the milk from the jug
to the tea cup.</p>

<p>In our existing system these transfers were seen as two different
classes of transfer, but the source and target were seen as containers.
In other words:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Container</span> <span class="p">;</span> <span class="k">end</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Kettle</span> <span class="o">&lt;</span> <span class="no">Container</span> <span class="p">;</span> <span class="k">end</span>
</span><span class='line'><span class="k">class</span> <span class="nc">TeaCup</span> <span class="o">&lt;</span> <span class="no">Container</span> <span class="p">;</span> <span class="k">end</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Jug</span> <span class="o">&lt;</span> <span class="no">Container</span> <span class="p">;</span> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">TransferType</span>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:transfers</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Transfer</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:transfer_type</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:source</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Container&#39;</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:target</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Container&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="k">class</span> <span class="nc">KettleToTeaCup</span> <span class="o">&lt;</span> <span class="no">Transfer</span> <span class="p">;</span> <span class="k">end</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MilkJugToTeaCup</span> <span class="o">&lt;</span> <span class="no">Transfer</span> <span class="p">;</span> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That is almost identical to the code we have.</p>

<p>The <code>TransferType</code> class is there to provide a description of the type
of transfer, for the UI mainly, but it plays an important part in what
I&#8217;m going to talk about.</p>

<p>This is wrong on so many levels but let&#8217;s start with the one I&#8217;m
bothered by the most, which is the fact that I can do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">KettleToTeaCup</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:source</span> <span class="o">=&gt;</span> <span class="no">TeaCup</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="ss">:target</span> <span class="o">=&gt;</span> <span class="no">Jug</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yes, I can say that I want to do a kettle-to-tea-cup transfer <strong>from</strong> a
tea cup <strong>to</strong> a jug!  It makes no sense.  And, believe me, people try.</p>

<p>In the new code I would like to avoid this but, more importantly, I
don&#8217;t see that the transfer needs to have its own class because we
already have the <code>TransferType</code> class which kind of does that.</p>

<p>What I&#8217;m trying to advocate is that we can inject behaviour, from the
transfer type, into a transfer.  In other words:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">TransferType</span>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">serialize</span> <span class="ss">:behaviours</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:transfers</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inject_behaviour_into</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span><span class='line'>    <span class="n">behaviours</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">module_name</span><span class="o">|</span>
</span><span class='line'>      <span class="n">record</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">module_name</span><span class="o">.</span><span class="n">constantize</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Transfer</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:transfer_type</span>
</span><span class='line'>  <span class="n">after_initialize</span> <span class="ss">:inject_transfer_behaviour</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inject_transfer_behaviour</span>
</span><span class='line'>    <span class="n">request_type</span><span class="o">.</span><span class="n">inject_behaviour_into</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="kp">private</span> <span class="ss">:inject_transfer_behaviour</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So now you&#8217;d write:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">TransferType</span><span class="o">.</span><span class="n">find_by_name</span><span class="p">(</span><span class="s1">&#39;Pour kettle into tea cup&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transfers</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:source</span> <span class="o">=&gt;</span> <span class="no">Kettle</span><span class="o">.</span><span class="n">new</span><span class="p">,</span> <span class="ss">:target</span> <span class="o">=&gt;</span> <span class="no">TeaCup</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>How do the source and target relationships get setup?  By having a
couple of modules:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">KettleSource</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">extended</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">belongs_to</span><span class="p">(</span><span class="ss">:source</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Kettle&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="k">module</span> <span class="nn">TeaCupTarget</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">extended</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">belongs_to</span><span class="p">(</span><span class="ss">:target</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;TeaCup&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then defining:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">TransferType</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span>
</span><span class='line'>  <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Pour kettle into tea cup&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:behaviours</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;KettleSource&#39;</span><span class="p">,</span> <span class="s1">&#39;TeaCupTarget&#39;</span> <span class="o">]</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>What use is that?  Well:</p>

<p>We&#8217;re guaranteeing that you can&#8217;t do the tea cup to jug transfer that I
demonstrated earlier because the associations are defined.  The real
advantage here is that we can get rid of the Container base class and put
tea cups in a tea_cups table, kettles in a kettles table, etc.  We have
a definitive relationship without having to resort to polymorpism.
Unfortunately we lose the ability to put in a foreign key relationship.</p>

<p>Also, the number of modules you require will aways be equal to, or
better than, the number of derived classes you would have to create.  At
3 types of &#8220;container&#8221; you have 6 modules (kettle as source, kettle as
target, tea cup as source, etc) but you&#8217;d have 9 classes (kettle-kettle,
kettle-tea cup, kettle-jug, tea cup-kettle, tea cup-tea cup, etc) in
order to get the same behaviours.  In other words, we are more flexible
with modules being injected.</p>

<p>I&#8217;ve over simplified the actual structure here.  In our existing
codebase someone has added a derived class that does not have a source
or target but references a &#8220;container&#8221; by abusing the source_id field,
and still calling it &#8220;source&#8221;.  In my suggested way we could do:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">OneThing</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">extended</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">belongs_to</span><span class="p">(</span><span class="ss">:tea_cup</span><span class="p">,</span> <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="ss">:source_id</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">&#39;TeaCup&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">TransferType</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span>
</span><span class='line'>  <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">&#39;Do nothing with a teacup&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:behaviours</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s1">&#39;OneThing&#39;</span> <span class="o">]</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Point being: if a transfer created through this type was passed to a
method that expected source or target to be defined on it the code would
blow up, not silently do something stupid.</p>

<p>The problem I face is that people who are used to a statically typed
language favour the hierarchy, even though Ruby does not enforce it.
Ruby is dynamic: as long as an object responds to a method why not call
it?  Why do we need to know that its a particular type?</p>

<p>These people do not see that this is actually a big plus.  This
technique (which is, in a way I&#8217;m guessing, <a href="http://en.wikipedia.org/wiki/Data,_context_and_interaction">DCI</a>)
would enable the new code to be far more flexible and far better
defined, even though it is based on the same data schema.</p>

<p>But, yet again, I have no reason that my suggestion is any better other
than my &#8220;gut&#8221;.  I&#8217;m going to suggest it, and I&#8217;ve written code to do
this as a prototype, but I have a suspicion it&#8217;ll be rejected.  I&#8217;m not
bothered that someone who&#8217;s going to be coding this (as I&#8217;m probably not
going to be far too busy to help out) chooses not to do it because they
don&#8217;t understand it, but I think it&#8217;ll only be refused because of the
classical statically typed mentality.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Matthew Denner</span></span>

      








  


<time datetime="2011-11-23T20:56:00+00:00" pubdate data-updated="true">Nov 23<span>rd</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/software-engineering/'>Software engineering</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mattdenner.github.com//blog/2011/11/23/disagreement-number-2/" data-via="mattdenner" data-counturl="http://mattdenner.github.com//blog/2011/11/23/disagreement-number-2/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/11/22/disagreement--1/" title="Previous Post: Disagreement #1">&laquo; Disagreement #1</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/12/31/2011-in-review/" title="Next Post: 2011: in review">2011: in review &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/03/18/things-ive-learned-this-week/">Things I've learned this week</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/31/2011-in-review/">2011: in review</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/23/disagreement-number-2/">Disagreement #2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/22/disagreement--1/">Disagreement #1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/09/10/things-ive-learned-this-week/">Things I've Learned This Week</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("mattdenner", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/mattdenner" class="twitter-follow-button" data-show-count="false">Follow @mattdenner</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Matthew Denner -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
